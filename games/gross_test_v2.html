<!Doctype html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <title>跑台機</title>
    
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 2em;
            margin: 20px 0;
        }

        #startBtn, .submit, #send, #next {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #startBtn, #send, #next {
            background-color: #4CAF50;
            color: #fff;
        }

        .submit {
            background-color: #007BFF;
            color: #fff;
        }

        #startBtn:hover, .submit:hover, #send:hover, #next:hover {
            background-color: #45a049;
        }

        #startBtn {
            font-size: 20px;
        }

        #test {
            display: none;
            text-align: center;
        }

        #image {
            margin: 20px 0;
            max-height: 400px;
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #timer {
            color: #000;
            font-size: 25px;
        }

        .text-block {
            font-size: 18px;
            margin: 5px 0;
        }

        input[type="text"] {
            width: 70%;
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        #pop {
            display: none;
            margin: 20px 0;
        }

        footer {
            font-size: 12px;
            color: grey;
            margin-top: 20px;
        }
    </style>
</head>

<script type="text/javascript">
    var TIME = 31;
    var numOfProbs;
    var tm;
    var data;
    var x;
    var state = 0;
    var correct = 0;
    var total = 0;
    var done;

    function parseMultiAns(data) {
        for (const item of Object.entries(data)) {
            if (typeof item[1]['answer'] === 'undefined') { continue; }
            var ans = JSON.stringify(item[1]['answer']).replace(/\"/g, "").split(" / ");
            item[1]['answer'] = ans;
        }
        return data;
    }

    function enterKeyEvent(event) {
        var getAns = document.getElementById("answer");
        var show = document.getElementById("timer");
        var ans = getAns.value;

        if (state === 1) {
            if (getAns.value !== "" & event.keyCode == 13) {
                state = 3 - state;
                update();
            }
        } else {
            if (event.keyCode == 13 & (ans.length > 0 | show.innerHTML == 0)) {
                state = 3 - state;
                nextProb();
            }
        }
    }

    function init() {
        $(document).ready(function () {
            var url = "./answersheet.csv";
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.js", function () {
                $.get(url, function (CSVdata) {
                    data = $.csv.toObjects(CSVdata);
                    numOfProbs = Object.keys(data).length;
                    data = parseMultiAns(data);

                    var btn = document.getElementById("startBtn");
                    var handler = function () {
                        btn.style.display = "none";
                        test.style.display = "block";
                        document.removeEventListener("keypress", enterPress);
                        state = 1;
                        done = new Array(numOfProbs + 1).fill(false);
                        startGame();
                    };
                    var enterPress = function (event) {
                        if (event.keyCode == 13) {
                            handler();
                        }
                    }

                    btn.addEventListener("click", handler);
                    document.addEventListener("keypress", enterPress);
                });
            });
        });
    }

    function startGame() {
        document.addEventListener("keypress", enterKeyEvent);
        var send = document.getElementById("send");
        send.addEventListener("click", update);
        var next = document.getElementById("next");
        next.addEventListener("click", nextProb);
        nextProb();
    }

    function checkAns(input, ansArr) {
        input = input.trim();
        return ansArr.includes(input);
    }

    function updateCorrect() {
        correct += 1;
        var cor = document.getElementById("correct");
        cor.innerHTML = correct;
    }

    function update() {
        var getAns = document.getElementById("answer");
        var ans = getAns.value;
        var showAns = document.getElementById("showAnswer");

        if (checkAns(ans, data[x]['answer'])) {
            updateCorrect();
            showAns.innerHTML = "Correct! The answer is: " + data[x]['answer'][0];
        } else {
            showAnswer();
        }
        showNext();
        updateTotal();
    }

    function showAnswer() {
        var showAns = document.getElementById("showAnswer");
        showAns.innerHTML = "Wrong. Correct Answer is: " + data[x]['answer'][0];
    }

    function showExplanation() {
        var exp = document.getElementById("showExplanation");
        if (JSON.stringify(data[x]['explanation']) === "\"\"") {
            exp.innerHTML = "詳解：還沒有人寫這題的詳解喔！"
            var pop = document.getElementById("pop");
            pop.style.display = "block";
        } else {
            exp.innerHTML = "詳解：" + data[x]['explanation'];
        }
    }

    function showNext() {
        var next = document.getElementById("next");
        next.style.display = "inline-block";
        showExplanation();
    }

    function hideNext() {
        var next = document.getElementById("next");
        next.style.display = "none";
    }

    function updateTotal() {
        total += 1;
        var tot = document.getElementById("total");
        tot.innerHTML = total;

        if (total === numOfProbs) {
            alert("You've reached the end of the problem list. The problems will be shown again in different order if you continue.")
            done = new Array(numOfProbs + 1).fill(false);
        }
    }

    function nextProb() {
        var pop = document.getElementById("pop");
        pop.style.display = "none";

        hideNext();
        updateImage();
        var getAns = document.getElementById("answer");
        getAns.value = "";
        var showAns = document.getElementById("showAnswer");
        showAns.innerHTML = "";
        var des = document.getElementById("description");
        des.value = "";
        var exp = document.getElementById("showExplanation");
        exp.innerHTML = "";
        resetTime();
        countdown();
    }

    function pickNewImage() {
        x = getRandomInt(1, numOfProbs);
        while (done[x] === true) {
            x = getRandomInt(1, numOfProbs);
        }
        done[x] = true;
        return x;
    }

    function updateImage() {
        x = pickNewImage();
        var picture = document.getElementById("image");
        var picref = data[x]['path'];
        picture.setAttribute('src', picref);

        var num = document.getElementById("num");
        num.innerHTML = data[x]['num'];

        var des = document.getElementById("description");
        des.innerHTML = data[x]['description'];
    }

    function countdown() {
        var show = document.getElementById("timer");
        if (show.innerHTML > 0) {
            show.innerHTML -= 1;
            tm = window.setTimeout(countdown, 1000);
        } else {
            clearTimeout(tm);
            showAnswer();
        }
        if (show.innerHTML <= 10) {
            show.style.color = "#ff0000";
        }
    }

    function resetTime() {
        var timer = document.getElementById("timer");
        timer.innerHTML = TIME;
        timer.style.color = "#000";
        clearTimeout(tm);
    }

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min) + min);
    }
</script>

<body onload="init();">
    <h1>跑台機</h1>
    <div>
        <div style="margin: 5px;">
            Gross exam ver.
        </div>
        <button id="startBtn">開始</button>
    </div>
    
    <div id="test">
        <div style="margin: 5px; font-size: 25px; display: inline-block;">Time left: <span id="timer">30</span> sec</div>
        <div class="text-block" style="display: inline-block;">答對率：<span id="correct">0</span>/<span id="total">0</span></div>
        <div class="text-block" id="description"></div>
        <img id="image" src="https://drive.google.com/thumbnail?id=1TeyV9xFcckCSs0zO-xvwVFeekxSiMj2g&sz=s1000" alt="Question Image"/>
        <div class="text-block">題目編號：<span id="num"></span></div>
        <div>
            <input id="answer" type="text" placeholder="輸入答案" />
            <button id="send">送出</button>
            <button id="next">下一題</button>
        </div>
        <div class="text-block" id="showAnswer"></div>
        <div class="text-block" id="showExplanation"></div>
    </div>
    
    <div id="pop">
    </div>
    <a href="https://docs.google.com/spreadsheets/d/1xx3LAOByVnspxKPGwn5-0AwReJq0pZLyomD6AtzHTnE/edit?usp=sharing" target="_blank">
        <button class="submit">我要勘誤/寫詳解/加題目</button>
    </a>
    
    <footer>
        Created by: Yu-Tong Cheng, Contributed by: B09 NTU MED.
        Slightly revised by Phantominor.
    </footer>
</body>

</html>
