<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>龑的交通月台</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/yanltjt/test.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
</head>
<body>
    <div id="headerPage"></div>
    <div class="content">
        <main>
            <section class="map-section">
                <h1 class="map-title">台灣國道、省道快速公路</h1>
                <div class="reference-line">Thanks to contribution of @yanltjtii</div>
                
                <div class="expand-control">
                    <div class="expand-line"></div>
                    <div class="expand-button" onclick="handleExpand()">
                        <span class="expand-arrow"></span>
                        <span>展開地圖</span>
                    </div>
                </div>

                <div class="loading-indicator">正在載入地圖...</div>
            
                <div id="map-wrapper" class="map-wrapper">
                    <div class="map-container">
                        <div id="encrypted-content"></div>
                    </div>
                </div>

                <div class="map-description">
                  <h2>關於本地圖</h2>
                  <p>此互動式地圖展示了台灣完整的省道與國道快速公路網絡系統。您可以在地圖上查看：</p>
                  <p>• 主要省道路線與編號<br>
                      • 國道快速公路網絡<br>
                      • 重要交通樞紐與連接點<br>
                      • 即時路況更新 (通過 Google Maps 整合)</p>
                  <p>點擊地圖上的各個路段可查看詳細資訊。您可以使用滾輪或手勢進行縮放，拖曳以平移地圖視角。</p>
                  <p><strong>注意：</strong>本地圖內容受版權保護，未經授權不得複製或轉載。</p>
              </div>
            </section>
        </main>
    </div>
    <div id="footerPage"></div>

    <script src="/assets/js/script.js"></script>
    <script>
        const encryptedContent = "jpgKhnaEpLxf3170jIebwppRNSgZ8otn3YVjWLB+eDECMJtju+EOy8obAp7kzmU4L+HLKJrf0UY3J9gdkNROy6Gf8M9MZnGW8obdhBNABsRUn4tjVTO9SzSzyxS7/cma9ciNuUQKztlNWZZ7haC0UGDpRrSBZFZvJ1k4E3+9SAA7kgUhs7XUjKUzH+SOaEkrpjfPiQYO3I/N0nwYhzjhoH+JJg6P4RMRGaEcOiH7jBpM7XSrkKUsSaQgR0A7Xw4hF5KDQ5buQaatnO5fCXkcWnjqY16QjpUopFNOzbaB8eAuEcPEY2YMbLlOVYfoELQgWsQNOkg9K2aPwa9xkQaxRg==";
        
        async function fetchKeyPart(filename) {
            try {
                const response = await fetch(`/assets/database/${filename}`);
                const data = await response.json();
                return data.keys[0].pv;
            } catch (error) {
                console.error(`Error fetching ${filename}:`, error);
                throw error;
            }
        }

        async function assemblePrivateKey() {
            try {
                const [part1, part2, part3] = await Promise.all([
                    fetchKeyPart('rivest.json'),
                    fetchKeyPart('shamir.json'),
                    fetchKeyPart('adleman.json')
                ]);
                return part1 + part2 + part3;
            } catch (error) {
                console.error('Failed to assemble private key:', error);
                throw new Error('Failed to assemble private key');
            }
        }

        async function handleExpand() {
            const wrapper = document.getElementById('map-wrapper');
            const loadingIndicator = document.querySelector('.loading-indicator');
            const expandButton = document.querySelector('.expand-button');
            
            if (!wrapper.classList.contains('expanded')) {
                expandButton.style.pointerEvents = 'none';
                loadingIndicator.classList.add('active');
                
                try {
                    const privateKey = await assemblePrivateKey();
                    const decrypt = new JSEncrypt();
                    decrypt.setPrivateKey(privateKey);
                    
                    const decrypted = decrypt.decrypt(encryptedContent);
                    if (decrypted) {
                        document.getElementById('encrypted-content').innerHTML = decrypted;
                        wrapper.classList.add('expanded');
                        expandButton.style.opacity = '0';
                        setTimeout(() => {
                            expandButton.style.display = 'none';
                        }, 300);
                    } else {
                        throw new Error('Decryption failed');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('無法載入地圖，請稍後再試。');
                } finally {
                    loadingIndicator.classList.remove('active');
                    expandButton.style.pointerEvents = 'auto';
                }
            }
        }
    </script>
</body>
</html>