<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資源鏈接管理系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.2.1/jsencrypt.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --text-color: #333;
            --bg-color: #f9f9f9;
            --card-bg: #fff;
            --highlight-color: #ffffa3;
            --border-color: #e0e0e0;
            --hover-color: #edf2f7;
            --tag-bg: #e1f5fe;
            --tag-text: #0288d1;
            --active-bg: #2980b9;
            --active-text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* Search area */
        .search-area {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }

        .search-box-container {
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .category-filters {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-button {
            padding: 8px 16px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .filter-button:hover {
            background-color: var(--hover-color);
        }

        .filter-button.active {
            background-color: var(--active-bg);
            color: var(--active-text);
            border-color: var(--active-bg);
        }

        /* Link display area */
        .links-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-section {
            margin-bottom: 30px;
            grid-column: 1 / -1;
        }

        .major-category-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-size: 1.2rem;
            border-radius: 8px 8px 0 0;
        }

        .minor-category {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .minor-category-header {
            background-color: #f0f0f0;
            padding: 12px 15px;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }

        .link-container {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .link-button {
            display: block;
            padding: 12px 15px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: var(--text-color);
            height: 100%;
        }

        .link-button:hover {
            background-color: var(--hover-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .link-title {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        .link-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .link-tags {
            display: flex;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .link-tag {
            font-size: 0.8rem;
            padding: 2px 8px;
            margin-right: 5px;
            margin-bottom: 5px;
            background-color: var(--tag-bg);
            color: var(--tag-text);
            border-radius: 12px;
        }

        .highlight {
            background-color: var(--highlight-color);
            padding: 0 2px;
            border-radius: 2px;
        }

        .no-results {
            text-align: center;
            padding: 30px;
            font-size: 1.2rem;
            color: #666;
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .link-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>資源鏈接管理系統</h1>
        </header>
        
        <div class="search-area">
            <div class="search-box-container">
                <input type="text" id="searchBox" class="search-box" placeholder="搜索鏈接名稱、描述或標籤...">
            </div>
            
            <div class="category-filters">
                <div class="filter-row" id="majorCategoryFilters">
                    <!-- Major category filter buttons will be added here -->
                    <div class="loading">加載中...</div>
                </div>
                
                <div class="filter-row" id="minorCategoryFilters" style="display: none;">
                    <!-- Minor category filter buttons will be added here -->
                </div>
            </div>
        </div>
        
        <div class="links-area" id="linksArea">
            <!-- Links will be added here dynamically -->
            <div class="loading">加載資源中...</div>
        </div>
    </div>

    <script>
        // Encrypted data
        const encryptedSpreadsheetId = "PHmUeiQhUA4lUivD7sJy1+rpbioTp6+HXmTc3Moe04seM08upwWpGs8tKP80EJ93ce+UnbGwieoODJKwo71uUo0LqZF0jYyZq+oYuu2mgZd7EFxeuL9wggtOanxgsD4pY5U4LVG4J6UCjgOxqbA7PnG1ZhPVmEDWmMrbvkOMbzDxvNisA1aVL0RJNDz1efzxeYDvbjK8m8drbGv+zdnKdToqxM4dKE3KJLwKrKfQaRo/6uaEot2pLCIpuXyMqw9r0RJSinJe4l6ydBSfr/VTol4nXYOT+b1WFPJ9pHPC5gOvy0oUMNbCPgSRuBToDFDdHBAQNmuFa/nueDD0Y7fZ9A==";
        const API_KEY = 'AIzaSyBCtki_DIp5sUt1C_mOrNjNvywkeUxRQqw';
        const CATEGORIES_SHEET = '分類';
        const LINKS_SHEET = '連結';
        
        // DOM elements
        const searchBox = document.getElementById('searchBox');
        const majorCategoryFilters = document.getElementById('majorCategoryFilters');
        const minorCategoryFilters = document.getElementById('minorCategoryFilters');
        const linksArea = document.getElementById('linksArea');

        // State
        let spreadsheetId = null;
        let categoryStructure = [];
        let linkData = [];
        let selectedMajorCategory = null;
        let selectedMinorCategory = null;
        let searchQuery = '';
        let isLoading = true;

        async function fetchKeyPart(filename) {
            try {
                const response = await fetch(`/assets/database/${filename}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${filename}: ${response.status}`);
                }
                
                const data = await response.json();
                
                const matchingKey = data.keys.find(key => 
                    key.ec === encryptedSpreadsheetId
                );
                
                if (!matchingKey) {
                    throw new Error(`No matching key found in ${filename}`);
                }
                
                return matchingKey.pv;
            } catch (error) {
                console.error(`Error fetching or processing ${filename}:`, error);
                throw error;
            }
        }

        async function assemblePrivateKey() {
            try {
                const [part1, part2, part3] = await Promise.all([
                    fetchKeyPart('rivest.json'),
                    fetchKeyPart('shamir.json'),
                    fetchKeyPart('adleman.json')
                ]);
                return part1 + part2 + part3;
            } catch (error) {
                console.error('Failed to assemble private key:', error);
                throw new Error('Failed to assemble private key');
            }
        }

        async function decryptSpreadsheetId() {
            try {
                const privateKey = await assemblePrivateKey();
                const decrypt = new JSEncrypt();
                decrypt.setPrivateKey(privateKey);
                const decrypted = decrypt.decrypt(encryptedSpreadsheetId);

                if (!decrypted) {
                    throw new Error('Decryption failed');
                }
                
                return decrypted;
            } catch (error) {
                console.error('Failed to decrypt spreadsheet ID:', error);
                throw new Error('Failed to decrypt spreadsheet ID');
            }
        }

        // Fetch data from Google Sheets
        async function fetchSheetData(sheetName) {
            try {
                if (!spreadsheetId) {
                    throw new Error('Spreadsheet ID not available');
                }
                
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${API_KEY}`
                );
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${sheetName} data: ${response.statusText}`);
                }
                
                return response.json();
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                throw error;
            }
        }

        // Load category structure from Google Sheets
        async function loadCategoryStructure() {
            const data = await fetchSheetData(CATEGORIES_SHEET);
            const values = data.values || [];
            
            if (values.length === 0) {
                console.warn('No category data found.');
                return;
            }
            
            // Process the category data
            // Expected format: Each row has a major category in column A,
            // followed by minor categories in subsequent columns
            const processedCategories = [];
            
            for (const row of values) {
                if (row.length === 0 || !row[0]) continue;
                
                const majorCategory = row[0];
                const minorCategories = row.slice(1).filter(Boolean);
                
                processedCategories.push({
                    id: majorCategory,
                    name: majorCategory,
                    minorCategories: minorCategories.map(minor => ({
                        id: minor,
                        name: minor
                    }))
                });
            }
            
            categoryStructure = processedCategories;
            console.log('Category structure loaded:', categoryStructure);
        }

        // Load link data from Google Sheets
        async function loadLinkData() {
            const data = await fetchSheetData(LINKS_SHEET);
            const values = data.values || [];
            
            if (values.length < 2) {
                console.warn('No link data found or missing headers.');
                return;
            }
            
            // Get column headers (first row)
            const headers = values[0];
            
            // Find the index for each required field
            const titleIndex = headers.indexOf('標題');
            const urlIndex = headers.indexOf('連結');
            const descriptionIndex = headers.indexOf('描述');
            const majorCategoryIndex = headers.indexOf('大分類');
            const minorCategoryIndex = headers.indexOf('小分類');
            const tagsIndex = headers.indexOf('標籤');
            
            // Check if all required columns are present
            if (titleIndex === -1 || urlIndex === -1 || descriptionIndex === -1 || 
                majorCategoryIndex === -1 || minorCategoryIndex === -1 || tagsIndex === -1) {
                console.error('Missing required columns in the links sheet.');
                return;
            }
            
            // Process the data (skip the header row)
            const processedLinks = [];
            
            for (let i = 1; i < values.length; i++) {
                const row = values[i];
                
                if (row.length <= Math.max(titleIndex, urlIndex, descriptionIndex, majorCategoryIndex, minorCategoryIndex, tagsIndex)) {
                    continue; // Skip rows with insufficient columns
                }
                
                // Split tags by the '、' character
                const tagString = row[tagsIndex] || '';
                const tags = tagString.split('、').filter(Boolean);
                
                processedLinks.push({
                    id: `link-${i}`,
                    title: row[titleIndex] || '',
                    url: row[urlIndex] || '',
                    description: row[descriptionIndex] || '',
                    majorCategory: row[majorCategoryIndex] || '',
                    minorCategory: row[minorCategoryIndex] || '',
                    tags: tags
                });
            }
            
            linkData = processedLinks;
            console.log('Link data loaded:', linkData);
        }

        // Show error message
        function showErrorMessage(message) {
            isLoading = false;
            linksArea.innerHTML = `<div class="error-message">${message}</div>`;
            majorCategoryFilters.innerHTML = '';
        }

        // Initialize the page
        async function init() {
            try {
                // First, decrypt the spreadsheet ID
                spreadsheetId = await decryptSpreadsheetId();
                console.log('Successfully decrypted spreadsheet ID');
                
                // Load data from Google Sheets
                await loadCategoryStructure();
                await loadLinkData();
                
                isLoading = false;
                
                // Render UI
                renderMajorCategoryFilters();
                renderLinks();
                
                // Set up event listeners
                searchBox.addEventListener('input', handleSearch);
            } catch (error) {
                console.error('Error initializing the application:', error);
                showErrorMessage(`載入數據時出現錯誤: ${error.message}`);
            }
        }

        // Render major category filter buttons
        function renderMajorCategoryFilters() {
            majorCategoryFilters.innerHTML = '';
            
            // Add "All" button
            const allButton = document.createElement('button');
            allButton.className = `filter-button ${selectedMajorCategory === null ? 'active' : ''}`;
            allButton.textContent = '全部';
            allButton.addEventListener('click', () => selectMajorCategory(null));
            majorCategoryFilters.appendChild(allButton);
            
            // Add category buttons
            categoryStructure.forEach(category => {
                const button = document.createElement('button');
                button.className = `filter-button ${selectedMajorCategory === category.id ? 'active' : ''}`;
                button.textContent = category.name;
                button.addEventListener('click', () => selectMajorCategory(category.id));
                majorCategoryFilters.appendChild(button);
            });
        }

        // Render minor category filter buttons
        function renderMinorCategoryFilters() {
            minorCategoryFilters.innerHTML = '';
            
            // Show minor category filters only if a major category is selected
            if (selectedMajorCategory) {
                const majorCategory = categoryStructure.find(c => c.id === selectedMajorCategory);
                
                if (majorCategory) {
                    // Add "All" button
                    const allButton = document.createElement('button');
                    allButton.className = `filter-button ${selectedMinorCategory === null ? 'active' : ''}`;
                    allButton.textContent = `所有${majorCategory.name}`;
                    allButton.addEventListener('click', () => selectMinorCategory(null));
                    minorCategoryFilters.appendChild(allButton);
                    
                    // Add minor category buttons
                    majorCategory.minorCategories.forEach(minorCategory => {
                        const button = document.createElement('button');
                        button.className = `filter-button ${selectedMinorCategory === minorCategory.id ? 'active' : ''}`;
                        button.textContent = minorCategory.name;
                        button.addEventListener('click', () => selectMinorCategory(minorCategory.id));
                        minorCategoryFilters.appendChild(button);
                    });
                    
                    minorCategoryFilters.style.display = 'flex';
                }
            } else {
                minorCategoryFilters.style.display = 'none';
                selectedMinorCategory = null;
            }
        }

        // Select a major category
        function selectMajorCategory(categoryId) {
            selectedMajorCategory = categoryId;
            selectedMinorCategory = null;
            renderMajorCategoryFilters();
            renderMinorCategoryFilters();
            renderLinks();
        }

        // Select a minor category
        function selectMinorCategory(categoryId) {
            selectedMinorCategory = categoryId;
            renderMinorCategoryFilters();
            renderLinks();
        }

        // Handle search input
        function handleSearch() {
            searchQuery = searchBox.value.toLowerCase();
            renderLinks();
        }

        // Check if a link matches the current filters
        function linkMatchesFilters(link) {
            // Check if the link matches category filters
            const matchesMajorCategory = selectedMajorCategory === null || link.majorCategory === selectedMajorCategory;
            const matchesMinorCategory = selectedMinorCategory === null || link.minorCategory === selectedMinorCategory;
            
            // Check if the link matches search query
            const matchesSearch = searchQuery === '' || 
                link.title.toLowerCase().includes(searchQuery) || 
                link.description.toLowerCase().includes(searchQuery) || 
                link.tags.some(tag => tag.toLowerCase().includes(searchQuery));
            
            return matchesMajorCategory && matchesMinorCategory && matchesSearch;
        }

        // Highlight search term in text
        function highlightText(text, query) {
            if (!query) return text;
            
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Render links based on current filters
        function renderLinks() {
            linksArea.innerHTML = '';
            
            if (isLoading) {
                const loading = document.createElement('div');
                loading.className = 'loading';
                loading.textContent = '加載資源中...';
                linksArea.appendChild(loading);
                return;
            }
            
            // Filter links
            const filteredLinks = linkData.filter(link => linkMatchesFilters(link));
            
            if (filteredLinks.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.textContent = '沒有符合的結果';
                linksArea.appendChild(noResults);
                return;
            }
            
            // Group links by categories for display
            const groupedLinks = {};
            
            filteredLinks.forEach(link => {
                const majorCategoryId = link.majorCategory;
                const minorCategoryId = link.minorCategory;
                
                if (!groupedLinks[majorCategoryId]) {
                    groupedLinks[majorCategoryId] = {};
                }
                
                if (!groupedLinks[majorCategoryId][minorCategoryId]) {
                    groupedLinks[majorCategoryId][minorCategoryId] = [];
                }
                
                groupedLinks[majorCategoryId][minorCategoryId].push(link);
            });
            
            // Sort and render grouped links
            Object.keys(groupedLinks).sort().forEach(majorCategoryId => {
                // Find the major category object
                const majorCategoryObj = categoryStructure.find(c => c.id === majorCategoryId);
                const majorCategoryName = majorCategoryObj ? majorCategoryObj.name : majorCategoryId;
                
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                
                const majorCategoryHeader = document.createElement('div');
                majorCategoryHeader.className = 'major-category-header';
                majorCategoryHeader.textContent = majorCategoryName;
                categorySection.appendChild(majorCategoryHeader);
                
                Object.keys(groupedLinks[majorCategoryId]).sort().forEach(minorCategoryId => {
                    // Find the minor category object (if exists)
                    let minorCategoryName = minorCategoryId;
                    if (majorCategoryObj) {
                        const minorCategoryObj = majorCategoryObj.minorCategories.find(c => c.id === minorCategoryId);
                        if (minorCategoryObj) {
                            minorCategoryName = minorCategoryObj.name;
                        }
                    }
                    
                    const links = groupedLinks[majorCategoryId][minorCategoryId];
                    
                    // Sort links alphabetically
                    links.sort((a, b) => a.title.localeCompare(b.title));
                    
                    const minorCategoryElement = document.createElement('div');
                    minorCategoryElement.className = 'minor-category';
                    
                    const minorCategoryHeader = document.createElement('div');
                    minorCategoryHeader.className = 'minor-category-header';
                    minorCategoryHeader.textContent = minorCategoryName;
                    minorCategoryElement.appendChild(minorCategoryHeader);
                    
                    const linkContainer = document.createElement('div');
                    linkContainer.className = 'link-container';
                    
                    links.forEach(link => {
                        const linkElement = createLinkElement(link);
                        linkContainer.appendChild(linkElement);
                    });
                    
                    minorCategoryElement.appendChild(linkContainer);
                    categorySection.appendChild(minorCategoryElement);
                });
                
                linksArea.appendChild(categorySection);
            });
        }

        // Create link element
        function createLinkElement(link) {
            const linkElement = document.createElement('a');
            linkElement.className = 'link-button';
            linkElement.href = link.url;
            linkElement.target = '_blank';
            
            const title = document.createElement('div');
            title.className = 'link-title';
            title.innerHTML = highlightText(link.title, searchQuery);
            
            const description = document.createElement('div');
            description.className = 'link-description';
            description.innerHTML = highlightText(link.description, searchQuery);
            
            const tags = document.createElement('div');
            tags.className = 'link-tags';
            
            link.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'link-tag';
                tagElement.innerHTML = highlightText(tag, searchQuery);
                tags.appendChild(tagElement);
            });
            
            linkElement.appendChild(title);
            linkElement.appendChild(description);
            linkElement.appendChild(tags);
            
            return linkElement;
        }

        // Initialize the application
        init();
    </script>
</body>
</html>