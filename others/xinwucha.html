<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心無查</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <style>
        :root {
            --primary-color: #3a6ea5;
            --secondary-color: #f0f4f8;
            --text-color: #333;
            --border-color: #ddd;
        }

        .questionnaire-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .questionnaire-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 15px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .questionnaire-table th:hover {
            background-color: #2c5694;
        }

        .questionnaire-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .questionnaire-table tr:nth-child(even) {
            background-color: var(--secondary-color);
        }

        .questionnaire-table tr:hover {
            background-color: #e6f2ff;
        }

        .form-link, .analysis-link {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: bold;
            transition: color 0.3s;
        }

        .form-link:hover, .analysis-link:hover {
            color: #1a4a7a;
            text-decoration: underline;
        }

        .platform-links {
            display: flex;
            gap: 10px;
        }

        .platform-btn {
            display: inline-block;
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.8em;
            transition: background-color 0.3s;
        }

        .platform-btn:hover {
            background-color: #2c5694;
        }

        @media (max-width: 768px) {
            .questionnaire-table {
                font-size: 0.9em;
            }
            .platform-links {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="headerPage"></div> <!-- Placeholder for the header -->
    <div class="content">
        <div id="profileColumnPage"></div> <!-- Placeholder for the profile column -->
        <main>
            <h1>伊心凡特姆的無聊小調查</h1>
    
            <table id="questionnaireTable" class="questionnaire-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0, 'number')">編號</th>
                        <th onclick="sortTable(1, 'date')">開始時間</th>
                        <th onclick="sortTable(2, 'text')">調查標題</th>
                        <th onclick="sortTable(3, 'number')">回覆數量</th>
                        <th>表單連結</th>
                        <th onclick="sortTable(5, 'number')">填寫時間 (s)</th>
                        <th onclick="sortTable(7, 'date')">結束時間</th>
                    </tr>
                </thead>
                <tbody id="questionnaireTableBody">
                    <!-- Table rows will be dynamically populated -->
                </tbody>
            </table>
        </main>
    </div>
    <div id="footerPage"></div> <!-- Placeholder for the footer -->

    <script src="/assets/js/script.js"></script>
    <script>
        const API_KEY = 'AIzaSyBCtki_DIp5sUt1C_mOrNjNvywkeUxRQqw';

// Function to fetch replies count from Google Sheets
async function fetchRepliesCount(spreadsheetId) {
    try {
        const response = await fetch(
            `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/表單回應 1!A:Z?key=${API_KEY}`
        );
        const data = await response.json();
        
        // Count rows with actual data (subtract header row)
        const filledRows = data.values ? 
            data.values.filter(row => row.some(cell => cell.trim() !== '')).length - 1 
            : 0;
        
        return Math.max(0, filledRows);
    } catch (error) {
        console.error('Error fetching replies:', error);
        return 0;
    }
}

// Fetch and render questionnaire data
async function initializeQuestionnaires() {
    try {
        // Fetch JSON data
        const response = await fetch('/assets/database/xinwucha.json');
        const jsonData = await response.json();
        
        // Fetch replies for each questionnaire
        const questionnairesWithReplies = await Promise.all(
            jsonData.questionnaires.map(async (item) => ({
                ...item,
                currentReplies: await fetchRepliesCount(item.spreadsheetID)
            }))
        );

        // Render the table
        renderTable(questionnairesWithReplies);
    } catch (error) {
        console.error('Error initializing questionnaires:', error);
    }
}

function renderTable(data) {
    const tableBody = document.getElementById('questionnaireTableBody');
    tableBody.innerHTML = '';

    data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.number}</td>
            <td>${item.startTime}</td>
            <td>
                <a href="${item.analysisLink}" class="analysis-link">${item.title}</a>
            </td>
            <td>${item.currentReplies}</td>
            <td>
                <a href="${item.formLink}" target="_blank" class="form-link">填寫問卷</a>
            </td>
            <td>${item.estimatedTime}</td>
            <td>${item.endTime}</td>
        `;
        tableBody.appendChild(row);
    });
}

function sortTable(columnIndex, type) {
    const table = document.getElementById('questionnaireTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const sortedRows = rows.sort((a, b) => {
        const cellA = a.getElementsByTagName('td')[columnIndex].textContent;
        const cellB = b.getElementsByTagName('td')[columnIndex].textContent;

        switch(type) {
            case 'number':
                return Number(cellA) - Number(cellB);
            case 'date':
                return new Date(cellA.replace(/\//g, '-')) - new Date(cellB.replace(/\//g, '-'));
            case 'text':
                // Chinese character stroke count sorting (simplified)
                return cellA.localeCompare(cellB, 'zh-TW');
            default:
                return cellA.localeCompare(cellB);
        }
    });

    // Clear and repopulate the table
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
}

// Initialize on page load
initializeQuestionnaires();
</script>
</body>
</html>
